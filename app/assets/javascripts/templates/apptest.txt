ticketApp = angular.module('TicketModule', ['templates', 'ngRoute', 'ngResource', 'ngMessages']);

ticketApp.factory("Ticket", function($resource,$location) {

    extractid = function(ori,w1,w2) {
   	  var ss1 = ori.substr(ori.search(w1)+w1.length,ori.length);
   	  var id = ss1.substr(0,ss1.search(w2));   	  
   	  return id; 
    }

    var projectId = extractid($location.absUrl(),"projects/","/tickets");

    return $resource("/tickets/index/:project_id.json", {"project_id": projectId }, {
 
    index:   { method: 'GET', isArray: true, responseType: 'json' },
    update:  { method: 'PUT', responseType: 'json' } 

  });
});

ticketApp.controller("itemsControllerHiddenDiv", ["$scope", "$routeParams" ,function($scope, $routeParams) {
    
    var store = this;
    var div = document.getElementById("div-project-data");
    
    $scope.project = {name: div.getAttribute("data-project-name"),
                      id:   div.getAttribute("data-project-id")                     
    };
    store.project = $scope.project;
    $routeParams.id = store.id;
}]);

ticketApp.controller("ProjectController", ["$scope", "$resource" ,function($scope, $resource) {
	
	var ProjectInfo = $resource('/projects/show.json');

	$scope.SetProjectId = function(pprojectId) {
		$scope.project = ProjectInfo.get(
			{ "project_id": pprojectId }
		)
	}
    
}]);

ticketApp.controller("TicketListCtrl", [ "$scope", "$http", "$location", "$resource", "$routeParams", "Ticket", 
                                function ($scope, $http, $location, $resource, $routeParams, Ticket) {


    var div = document.getElementById('div-project-data');
    
    $scope.project = {id:   div.getAttribute("data-project-id")                     
                     };

   $scope.PprojectId = $scope.project.id;           
   $scope.tickets = Ticket.index();                                                
   $scope.save = function() {
   	                      if ($scope.form.$valid) {
   	                         alert("Save!");
   	                      }
   	                      
                          ticket = Ticket.save($scope.newTicket)
                          $scope.tickets.push(ticket)
                          $scope.newTicket = {}
                       }

   $scope.deleteTicket = function(index) {
     ticket = $scope.tickets[index]
     Ticket.delete(ticket)
     $scope.tickets.splice(index, 1);
   }      
}]);